<!DOCTYPE html>
<html>
<head>
    <title>Chat - User 15</title>
    <style>
        body { font-family: Arial, sans-serif; background: #18191a; color: #e4e6eb; padding: 0; margin: 0; }
        .container { max-width: 600px; margin: 30px auto 0 auto; background: #242526; border-radius: 10px; box-shadow: 0 2px 8px #000; padding: 15px 15px 0 15px;}
        #output { height: 440px; overflow-y: auto; display: flex; flex-direction: column; background: #18191a; border-radius: 8px; padding: 10px;}
        .input-group { display: flex; margin-top: 10px; }
        #message { flex: 1; padding: 10px; border-radius: 20px; border: none; font-size: 16px; background: #3a3b3c; color: white;}
        button { margin-left: 10px; border: none; padding: 10px 26px; background: #0084ff; color: #fff; border-radius: 18px; font-weight: bold; cursor: pointer;}
        .msg-row { display: flex; align-items: flex-end; margin-bottom: 6px;}
        .sent { justify-content: flex-end; }
        .received { justify-content: flex-start; }
        .msg-bubble { max-width: 63%; padding: 9px 16px; border-radius: 17px; font-size: 16px;}
        .sent .msg-bubble { background: #0084ff; color: #ffffff; border-bottom-right-radius: 4px;}
        .received .msg-bubble { background: #3a3b3c; color: #e4e6eb; border-bottom-left-radius: 4px;}
    </style>
</head>
<body>
<div class="container">
    <h3 style="margin-bottom:4px;">Chat as User 15</h3>
    <div id="output"></div>
    <div class="input-group">
        <input type="text" id="message" placeholder="Type a message..." autocomplete="off" 
            onkeypress="if(event.key==='Enter'){ sendMessage();}">
        <button onclick="sendMessage()">Send</button>
    </div>
</div>
<script>
    const WS_URL = "wss://mini-chat-sys.loca.lt";
    const userId = 15;
    const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjE1LCJ1c2VyTmFtZSI6ImpheWFudGgiLCJleHBUaW1lIjoxNzYyMTcwNTk2fQ.H_hwF2Z99JTR_fQawqXraKkiePNQwS9OgcMMcRNgYYA";
    const ws = new WebSocket(`${WS_URL}/chat/ws/${userId}?token=${token}`);
    const output = document.getElementById('output');

    ws.onopen = () => addSysMsg("Connected!");
    ws.onclose = () => addSysMsg("Disconnected!");
    ws.onerror = e => addSysMsg("WebSocket Error!");

    ws.onmessage = e => {
        try {
            // JSON: Own sent message confirmation from server
            const msg = JSON.parse(e.data);
            if (
                typeof msg === 'object' &&
                msg.sender_id === userId &&
                msg.content
            ) {
                // Ignore confirmation - we already show sent messages immediately!
                return;
            }
        } catch {
            // Not JSON: plain message from other user
            if (e.data.startsWith('User')) {
                let match = e.data.match(/^User (\d+): (.+)$/);
                if (match && parseInt(match[1]) !== userId) {
                    addMsg(match[2], 'received');
                }
            }
        }
    };

    function sendMessage() {
        const input = document.getElementById('message');
        const text = input.value.trim();
        if (!text || ws.readyState !== 1) return;
        addMsg(text, 'sent');
        ws.send(JSON.stringify({to: 14, content: text}));
        input.value = '';
    }

    function addMsg(text, cls) {
        const row = document.createElement('div');
        row.className = `msg-row ${cls}`;
        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        bubble.textContent = text;
        row.appendChild(bubble);
        output.appendChild(row);
        output.scrollTop = output.scrollHeight;
    }
    function addSysMsg(text) {
        const row = document.createElement('div');
        row.style.textAlign = "center";
        row.style.fontSize = "13px";
        row.style.color = "#bbb";
        row.style.padding = "7px";
        row.textContent = text;
        output.appendChild(row);
        output.scrollTop = output.scrollHeight;
    }
</script>
</body>
</html>