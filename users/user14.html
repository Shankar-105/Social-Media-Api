<!DOCTYPE html>
<html>
<head>
    <title>Chat - User 14</title>
    <style>
        body { font-family: Arial, sans-serif; background: #18191a; color: #e4e6eb; padding: 0; margin: 0; }
        .container { max-width: 600px; margin: 30px auto 0 auto; background: #242526; border-radius: 10px; box-shadow: 0 2px 8px #000; padding: 15px 15px 0 15px;}
        #output { height: 440px; overflow-y: auto; display: flex; flex-direction: column; background: #18191a; border-radius: 8px; padding: 10px;}
        .input-group { display: flex; margin-top: 10px; }
        #message { flex: 1; padding: 10px; border-radius: 20px; border: none; font-size: 16px; background: #3a3b3c; color: white;}
        button { margin-left: 10px; border: none; padding: 10px 26px; background: #0084ff; color: #fff; border-radius: 18px; font-weight: bold; cursor: pointer;}
        .msg-row { display: flex; align-items: flex-end; margin-bottom: 6px;}
        .sent { justify-content: flex-end; }
        .received { justify-content: flex-start; }
        .msg-bubble { max-width: 63%; padding: 9px 16px; border-radius: 17px; font-size: 16px;}
        .sent .msg-bubble { background: #0084ff; color: #ffffff; border-bottom-right-radius: 4px;}
        .received .msg-bubble { background: #3a3b3c; color: #e4e6eb; border-bottom-left-radius: 4px;}
    </style>
</head>
<body>
<div class="container">
    <h3 style="margin-bottom:4px;">Chat as User 14</h3>
    <div id="output"></div>
    <div class="input-group">
        <input type="text" id="message" placeholder="Type a message..." autocomplete="off" 
            onkeypress="if(event.key==='Enter'){ sendMessage();}">
        <button onclick="sendMessage()">Send</button>
    </div>
</div>
<script>
    const WS_URL = "wss://mini-chat-sys.loca.lt";
    const userId = 14;
    const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjE0LCJ1c2VyTmFtZSI6Inlhc2giLCJleHBUaW1lIjoxNzYyMjYyNzg3fQ.qq98e5ZF9va6VYx_HxCNf7fiYZDSiEdMbkXN7XmTQ_8";
    // whenever user opens the app this url in the args of 'new WebSocket' is called
    // and a WebSocket obj is created if the token authincation is successfull
    // and now this opens the live tunnel between the sender and the server
    const ws = new WebSocket(`${WS_URL}/chat/ws/${userId}?token=${token}`);
    const output = document.getElementById('output');
    // .onopen() is the method which is hit when ever the connection is succesfull
    ws.onopen = () => addSysMsg("Connected!");
    // .onclose() if the user closes the tab or the server crashes
    ws.onclose = () => addSysMsg("Disconnected!");
    // if any connection errors
    ws.onerror = e => addSysMsg("WebSocket Error!");
    // this .onmessage() is called whenever the server responds
    // suppose user14 sends a message to user15
    // case-1
    // then the user15's .onmessage() will ge called and 
    // displays the text it recives from the server
    // that is our backend routes(send_to_user)
    // case-2 
    // then user14 will also recive a pesonal message of what he sent
    // then his user14's .onmessage() is called and gets from the server
    // what he sent which we neatly display via frontend

    // this e is the message from the server
    ws.onmessage = e => {
        try {
            // server may reply with json or string
            // we parse it to a json object which the frontend uses to disply us
            const msg = JSON.parse(e.data);
            if (
                // if the sender_id == userId which means its the message to the same user14
                // here we ignore it for development we just display the message as sent soon after
                // sender sends the message so we ignore it here
                typeof msg === 'object' &&
                msg.sender_id === userId &&
                msg.content
            ) {
                // Ignore confirmation - we already show sent messages right away!
                return;
            }
            // or else if its a string it will not have those attributes like sender_id,content
            // as its a raw stirng so its an error object msg has no such attributes
            // and the catch block catches it which means its a message from some one else 
        } catch {
            // so jsut display it 
            if (e.data.startsWith('User')) {
                let match = e.data.match(/^User (\d+): (.+)$/);
                if (match && parseInt(match[1]) !== userId) {
                    addMsg(match[2], 'received');
                }
            }
        }
    };
    // whenever the user hits the send button 
    function sendMessage() {
        const input = document.getElementById('message');
        const text = input.value.trim();
        if (!text || ws.readyState !== 1) return;
        // Show sent message IMMEDIATELY (optimistic, like real chat)
        addMsg(text,'sent');
        // .send() sends the string in the msg entered in the type message box
        // it converts it to a string and sends it whihc is very vital anyhwere
        // always frontend sends the data in the form of json to backend
        // and now the aawaiting 'await websocket.receive_text()' recives this
        // and does the rest of the process
        ws.send(JSON.stringify({to: 15, content: text}));
        input.value = '';
    }

    function addMsg(text, cls) {
        const row = document.createElement('div');
        row.className = `msg-row ${cls}`;
        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        bubble.textContent = text;
        row.appendChild(bubble);
        output.appendChild(row);
        output.scrollTop = output.scrollHeight;
    }
    function addSysMsg(text) {
        const row = document.createElement('div');
        row.style.textAlign = "center";
        row.style.fontSize = "13px";
        row.style.color = "#bbb";
        row.style.padding = "7px";
        row.textContent = text;
        output.appendChild(row);
        output.scrollTop = output.scrollHeight;
    }
</script>
</body>
</html>